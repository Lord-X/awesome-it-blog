## 阶段1：All in one阶段

起初，与大部分项目开始阶段相同，也是将所有的东西一股脑的放到一个项目里。由于广告平台与前端交互最直接的就是广告投放机了，所以这个阶段整个商业平台相当于只有一个广告投放机。然后还有一个基本的后台系统。


![广告平台架构演进1-1](http://image.feathers.top/image/广告平台架构演进1-1.png)

广告投放机（All in One）

* Web接口接入广告投放请求。
* 广告投放策略服务：负责拉取配置，得到在哪个位置需要什么样的广告。
* 广告检索服务：根据广告的定向条件找出符合条件的广告并召回。

## 阶段2：正排检索服务拆分、第三方广告拆分

为啥做这两个服务的拆分？

由于正排检索做的事情就是将备选广告根据广告投放定向条件投放给合适的人群，所以，他的入参就是备选广告列表，返回参数是匹配的广告，是一个无状态服务，所以可以直接拆出来。

在这个阶段，正排检索服务以jar包形式存在。

其次，第三方API广告在产品形态上比较独立，他做的事情就是向第三方发起广告请求，并将第三方返回的广告物料信息封装，返回给前台。
而且他的系统性能指标比较依赖于第三方，如果第三方接口有啥问题，或者网络有问题，可能直接导致我们整个服务收到影响（CLOSE_WAIT升高，CPU load升高等问题），从这两方面考虑，可以将之单独拆分为一个服务。

![广告平台架构演进2](http://image.feathers.top/image/广告平台架构演进2.png)


## 阶段3：服务的进一步拆分

这一阶段中，对各个产品线的用户信息做了统一的获取封装，由于用户服务是相对独立的一个模块，所以单独拆出来。

由于激励体系的需要，形成的一个单独的金币服务，以jar包的形式存在于系统中。

此阶段还将广告投放策略服务提炼，形成一个单独的服务，以jar包的形式存在于系统中。

![广告平台架构演进3](http://image.feathers.top/image/广告平台架构演进3.png)

## 阶段4：直客代理商-倒排检索引擎

这一阶段，扩展直客代理商广告主，需要新的广告投放平台(ECP平台)，同时考虑到广告量的扩大可能会对广告检索带来压力，研发了倒排检索引擎（同样以jar包形式存在）。

至此，正排检索与倒排检索同时存在。正排检索负责第三方广告的检索，由于这部分广告由运营负责，广告量不会很大，正排检索是比较好的选择。倒排检索负责直客代理商广告的检索，考虑到代理商的广告量可能会很大，正排可能撑不住，所以由倒排检索负责这一部分广告。

![广告平台架构演进4](http://image.feathers.top/image/广告平台架构演进4.png)

## 阶段5：服务化、服务性能监控

这个阶段各个服务单独部署，通过motan完成rpc调用。监控Profile的收集和报表展示由Prometheus+Grafana完成。

![广告平台架构演进5](http://image.feathers.top/image/广告平台架构演进5.png)

## 阶段6：广告公共服务，CTR服务

这一阶段进一步将广告公共的部分提炼、抽象，形成公共服务，以motan服务部署。

同时为了解决广告出量过快、以及优化广告转化，研发了CTR预估服务。

![广告平台架构演进6](http://image.feathers.top/image/广告平台架构演进6.png)

## 阶段7：商业平台容器化

为提高资源的利用率，节省成本。商业平台进行了容器化。以Docker + K8s的方式部署。

![广告平台架构演进7](http://image.feathers.top/image/广告平台架构演进7.png)

## 阶段8：商业平台中台化

为啥要将平台中台化。首先聊一下中台的作用是什么，中台为前端而生的。在如今互联网时代，一个公司在商业战场上的成败越来越依赖能否快速响应用户的诉求。而前端是直接与用户接触的一端，传统的后台系统无法适应前端的快速变化，中台就是为了适应前端的快速变化而生的。

所以想要将商业平台沉淀成中台，首先需要了解其面对的前端。他的前端主要是H5和APP，还有未来可能扩充的新产品。所以广告中台需要设计成能适应前端和未来发展的平台。也就是说，一个新的广告位、一种新的广告形式或是新的产品接入广告中台时，不应有太多改动就能很好的适应。

再来看一下对于现有的广告系统来说，哪些属于前台，哪些属于中台，哪些属于后台。

在商业平台内部，广告公共服务、CTR服务、以及广告库的管理与具体的用户逻辑关系不大，属于后台服务。
正排检索、倒排检索、用户代理服务，这几个服务，相对稳定，无状态，作为中台而存在。
接入层、策略层，这两个服务变动相对较大，是产品需求迭代中改动最多的地方，作为前台存在。

由于商业平台内部的中台和后台对于业务前端是无感知的，所以商业平台的前台就是要改造成整个投放系统中台的部分了。



其他的中台还有：用户中台、账户中台、金币中台、任务中心中台